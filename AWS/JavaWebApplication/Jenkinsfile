def deploymentType
def branchName
def nexusServer
def nexusUser

pipeline {
    agent any
    tools {
        maven 'maven_3.6.3'
    }
    options { 
        buildDiscarder(logRotator(numToKeepStr: '3')) 
    }
    stages {
        stage ('Initialization') {
            steps {
                script {
                    branchName      = env.BRANCH_NAME.toLowerCase()
                    nexusServer     = 'ec2-18-191-173-191.us-east-2.compute.amazonaws.com:8081/'
                    nexusUser       = 'admin'
                    //nexusLink     = "http://${nexusServer}#browse/browse:maven-releases:com/emaratech/iqcs/${nexusArtifactId}"
                    if( branchName == 'master') {
                        deploymentType = 'qmg'
                    }

                    echo "deploymentType: ${deploymentType}, branchName: ${branchName}"
                }         
            }
        }
        stage ('Build') {
            steps {
                dir ("${WORKSPACE}/AWS/JavaWebApplication/") {
                    sh "ls -latr"
                    sh "mvn clean install"
                }
            }
        }
        stage ('Upload Artifatcs') {
            steps {
                script {
                    def nexusArtifactId     = deploymentType + '-' + env.BRANCH_NAME + '-' + env.BUILD_NUMBER
                    def artifactToUpload    = 'JavaWebApplication_JSP##1.0.5.war'
                    dir ("${WORKSPACE}/AWS/JavaWebApplication/target/") {
                        sh "ls -latr"
                        nexusArtifactUploader artifacts: [[artifactId: nexusArtifactId, classifier: '', file: artifactToUpload, type: 'zip']], credentialsId: nexusUser , groupId: 'org.umair.java', nexusUrl: nexusServer, nexusVersion: 'nexus3', protocol: 'http', repository: 'maven-releases', version: 'Pipeline-Db'
                    }
                }
            }
        }
    }
    post {
        cleanup {
            cleanWs()
        }
    }
}
